<!doctype html>
<html lang="ru" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bilimclass - –ñ—É—Ä–Ω–∞–ª –æ—Ü–µ–Ω–æ–∫</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Fredoka', sans-serif;
    }

    .gradient-blue {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .gradient-green {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .card-shadow {
      box-shadow: 0 10px 40px rgba(102, 126, 234, 0.15);
    }

    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .pulse-dot {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .grade-badge {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      font-weight: bold;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
    }

    .grade-badge:hover {
      transform: scale(1.05);
    }

    .grade-badge.selected {
      transform: scale(1.15);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }

    .grade-1-2 { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
    .grade-3-4 { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
    .grade-5-6 { background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%); }
    .grade-7-8 { background: linear-gradient(135deg, #84cc16 0%, #65a30d 100%); }
    .grade-9-10 { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }

    .stat-box {
      background: white;
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      card-shadow;
    }

    .stat-number {
      font-size: 36px;
      font-weight: bold;
      color: #667eea;
    }

    .stat-label {
      font-size: 14px;
      color: #666;
      margin-top: 8px;
    }

    .journal-table {
      width: 100%;
      border-collapse: collapse;
    }

    .journal-table th {
      background: #667eea;
      color: white;
      padding: 12px;
      text-align: left;
      font-weight: bold;
    }

    .journal-table td {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
    }

    .journal-table tr:hover {
      background: #f9f9f9;
    }

    .grade-cell {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .grade-cell:hover {
      background: #f0f0f0;
      transform: scale(1.05);
    }

    .empty-grade {
      color: #999;
      font-size: 20px;
    }

    input[type="text"],
    textarea,
    select {
      font-family: 'Fredoka', sans-serif;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 50;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-box {
      background: white;
      border-radius: 24px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      card-shadow;
    }

    .grade-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
    }

    .input-field {
      transition: all 0.3s ease;
    }

    .input-field:focus {
      transform: translateY(-2px);
    }

    .delete-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .delete-btn:hover {
      background: #dc2626;
      transform: scale(1.05);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-gradient-to-b from-blue-50 to-purple-50">
  <div id="app" class="h-full overflow-auto"><!-- ===== –ì–õ–ê–í–ù–´–ô –≠–ö–†–ê–ù –ñ–£–†–ù–ê–õ–ê ===== -->
   <div id="journal-screen" class="min-h-full p-4 py-6">
    <div class="max-w-7xl mx-auto"><!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
     <div class="mb-6 fade-in">
      <div class="flex items-center justify-between flex-wrap gap-4 mb-4">
       <div>
        <h1 class="text-4xl font-bold text-gray-800 flex items-center gap-3">üìö <span id="journal-title">Bilimclass</span> <span class="pulse-dot w-3 h-3 bg-green-500 rounded-full"></span></h1>
        <p class="text-gray-600 text-lg">–ñ—É—Ä–Ω–∞–ª –æ—Ü–µ–Ω–æ–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
       </div>
      </div><!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞ -->
      <div class="bg-white rounded-2xl p-4 card-shadow flex gap-3 flex-wrap items-center"><input type="text" id="new-student-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è —É—á–µ–Ω–∏–∫–∞..." class="flex-1 min-w-[200px] px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none focus:ring-4 focus:ring-purple-100"> <button id="add-student-btn" class="px-6 py-3 gradient-green text-white rounded-xl font-bold hover:shadow-lg transition-all transform hover:scale-105 active:scale-95"> ‚ûï –î–æ–±–∞–≤–∏—Ç—å </button>
      </div>
     </div><!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
     <div class="grid md:grid-cols-4 gap-4 mb-8">
      <div class="stat-box">
       <p class="stat-label">üë• –í—Å–µ–≥–æ —É—á–µ–Ω–∏–∫–æ–≤</p>
       <div class="stat-number" id="total-students">
        0
       </div>
      </div>
      <div class="stat-box">
       <p class="stat-label">‚≠ê –°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</p>
       <div class="stat-number" id="avg-grade">
        0
       </div>
       <p class="text-sm text-gray-500">–∏–∑ 10</p>
      </div>
      <div class="stat-box">
       <p class="stat-label">üìù –í—ã—Å—Ç–∞–≤–ª–µ–Ω–æ –æ—Ü–µ–Ω–æ–∫</p>
       <div class="stat-number" id="total-grades">
        0
       </div>
      </div>
      <div class="stat-box">
       <p class="stat-label">üìä –ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ü–µ–Ω—ë–Ω–Ω—ã—Ö</p>
       <div class="stat-number" id="percentage-graded">
        0%
       </div>
      </div>
     </div><!-- –¢–∞–±–ª–∏—Ü–∞ –∂—É—Ä–Ω–∞–ª–∞ -->
     <div class="bg-white rounded-2xl overflow-hidden card-shadow">
      <div class="overflow-x-auto">
       <table class="journal-table">
        <thead>
         <tr>
          <th style="width: 150px;">üë§ –£—á–µ–Ω–∏–∫</th>
          <th>üìÖ –î–∞—Ç–∞</th>
          <th style="width: 70px;">‚≠ê –û—Ü–µ–Ω–∫–∞</th>
          <th>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
          <th style="width: 120px;">üéØ –î–µ–π—Å—Ç–≤–∏–µ</th>
         </tr>
        </thead>
        <tbody id="journal-tbody">
         <tr>
          <td colspan="5" class="text-center py-8 text-gray-500">üì≠ –ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ —É—á–µ–Ω–∏–∫–∞ –∏ –≤—ã—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫—É.</td>
         </tr>
        </tbody>
       </table>
      </div>
     </div>
    </div>
   </div><!-- ===== –ú–û–î–ê–õ –û–¶–ï–ù–ò–í–ê–ù–ò–Ø ===== -->
   <div id="grade-modal" class="modal-overlay">
    <div class="modal-box fade-in">
     <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold text-gray-800">‚≠ê –í—ã—Å—Ç–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É</h2><button id="close-modal-btn" class="text-2xl text-gray-600 hover:text-gray-800 transition-all">‚úï</button>
     </div>
     <div class="gradient-blue text-white rounded-2xl p-4 mb-6">
      <p class="text-sm opacity-90">–£—á–µ–Ω–∏–∫:</p>
      <p id="modal-student-name" class="text-2xl font-bold">‚Äî</p>
     </div>
     <div class="mb-6"><label class="block text-lg font-bold text-gray-800 mb-4">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ü–µ–Ω–∫—É (1-10):</label>
      <div class="grade-grid"><button type="button" class="grade-badge grade-1-2" data-grade="1">1</button> <button type="button" class="grade-badge grade-1-2" data-grade="2">2</button> <button type="button" class="grade-badge grade-3-4" data-grade="3">3</button> <button type="button" class="grade-badge grade-3-4" data-grade="4">4</button> <button type="button" class="grade-badge grade-5-6" data-grade="5">5</button> <button type="button" class="grade-badge grade-5-6" data-grade="6">6</button> <button type="button" class="grade-badge grade-7-8" data-grade="7">7</button> <button type="button" class="grade-badge grade-7-8" data-grade="8">8</button> <button type="button" class="grade-badge grade-9-10" data-grade="9">9</button> <button type="button" class="grade-badge grade-9-10" data-grade="10">10</button>
      </div>
      <p class="text-sm text-gray-500 mt-4">–í—ã–±—Ä–∞–Ω–æ: <span id="selected-grade" class="font-bold text-purple-600">‚Äî</span></p>
     </div>
     <div class="mb-6"><label class="block text-lg font-bold text-gray-800 mb-2">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label> <textarea id="comment-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –æ—Ü–µ–Ω–∫–µ..." rows="3" class="input-field w-full px-4 py-3 text-base border-2 border-gray-300 rounded-2xl focus:border-purple-500 focus:outline-none focus:ring-4 focus:ring-purple-100 resize-none"></textarea>
     </div>
     <div class="flex gap-3"><button id="cancel-grade-btn" class="flex-1 py-4 bg-gray-100 text-gray-700 rounded-2xl font-bold hover:bg-gray-200 transition-all"> –û—Ç–º–µ–Ω–∞ </button> <button id="save-grade-btn" class="flex-1 py-4 gradient-green text-white rounded-2xl font-bold hover:shadow-lg transition-all transform hover:scale-105 active:scale-95"> ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å </button>
     </div>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      journal_title: 'Bilimclass - –ñ—É—Ä–Ω–∞–ª –æ—Ü–µ–Ω–æ–∫'
    };

    let config = { ...defaultConfig };
    let allData = [];
    let allStudents = [];
    let allGrades = [];
    let currentStudent = null;
    let currentGrade = null;

    // Data SDK
    const dataHandler = {
      onDataChanged(data) {
        allData = data;
        // –†–∞–∑–¥–µ–ª—è–µ–º —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏ –æ—Ü–µ–Ω–∫–∏
        allStudents = data.filter(item => item.type === 'student').map(s => s.student_name);
        allGrades = data.filter(item => item.type === 'grade');
        updateJournal();
      }
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    async function init() {
      if (window.dataSdk) {
        await window.dataSdk.init(dataHandler);
      }
      setupEventListeners();
      await onConfigChange(config);
      updateJournal();
    }

    function setupEventListeners() {
      document.getElementById('new-student-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          addStudent();
        }
      });

      document.getElementById('add-student-btn').addEventListener('click', addStudent);

      document.getElementById('close-modal-btn').addEventListener('click', closeModal);
      document.getElementById('cancel-grade-btn').addEventListener('click', closeModal);

      document.querySelectorAll('.grade-badge').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          document.querySelectorAll('.grade-badge').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          currentGrade = parseInt(btn.dataset.grade);
          document.getElementById('selected-grade').textContent = currentGrade;
        });
      });

      document.getElementById('save-grade-btn').addEventListener('click', async () => {
        if (!currentStudent || currentGrade === null) {
          alert('–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ü–µ–Ω–∫—É!');
          return;
        }

        const btn = document.getElementById('save-grade-btn');
        btn.disabled = true;
        btn.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω—è—é...';

        const comment = document.getElementById('comment-input').value.trim();
        const today = new Date().toLocaleDateString('ru-RU');

        const existingGrade = allGrades.find(g => g.student_name === currentStudent);

        if (existingGrade) {
          const result = await window.dataSdk.update({
            __backendId: existingGrade.__backendId,
            id: existingGrade.id,
            type: 'grade',
            student_name: currentStudent,
            score: currentGrade,
            date: today,
            comment: comment
          });

          if (result.isOk) {
            closeModal();
          }
        } else {
          const result = await window.dataSdk.create({
            id: 'grade-' + Date.now(),
            type: 'grade',
            student_name: currentStudent,
            score: currentGrade,
            date: today,
            comment: comment
          });

          if (result.isOk) {
            closeModal();
          }
        }

        btn.disabled = false;
        btn.textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
      });
    }

    async function addStudent() {
      const input = document.getElementById('new-student-input');
      const studentName = input.value.trim();

      if (!studentName) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è —É—á–µ–Ω–∏–∫–∞!');
        return;
      }

      if (allStudents.includes(studentName)) {
        alert('–≠—Ç–æ—Ç —É—á–µ–Ω–∏–∫ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω!');
        return;
      }

      const btn = document.getElementById('add-student-btn');
      btn.disabled = true;
      btn.textContent = '‚è≥ –î–æ–±–∞–≤–ª—è—é...';

      const result = await window.dataSdk.create({
        id: 'student-' + Date.now(),
        type: 'student',
        student_name: studentName,
        score: null,
        date: '',
        comment: ''
      });

      if (result.isOk) {
        input.value = '';
      }

      btn.disabled = false;
      btn.textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å';
    }

    function closeModal() {
      document.getElementById('grade-modal').classList.remove('active');
      currentStudent = null;
      currentGrade = null;
      document.querySelectorAll('.grade-badge').forEach(b => b.classList.remove('selected'));
      document.getElementById('selected-grade').textContent = '‚Äî';
      document.getElementById('comment-input').value = '';
    }

    function openGradeModal(studentName) {
      currentStudent = studentName;
      document.getElementById('modal-student-name').textContent = studentName;

      const existingGrade = allGrades.find(g => g.student_name === studentName);
      if (existingGrade) {
        currentGrade = existingGrade.score;
        document.getElementById('comment-input').value = existingGrade.comment || '';
        document.querySelectorAll('.grade-badge').forEach(btn => {
          if (parseInt(btn.dataset.grade) === currentGrade) {
            btn.classList.add('selected');
          }
        });
        document.getElementById('selected-grade').textContent = currentGrade;
      }

      document.getElementById('grade-modal').classList.add('active');
    }

    async function deleteStudent(studentName) {
      if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${studentName}?`)) return;
      
      const studentRecord = allData.find(d => d.type === 'student' && d.student_name === studentName);
      if (studentRecord) {
        await window.dataSdk.delete(studentRecord);
      }

      const gradeRecord = allGrades.find(g => g.student_name === studentName);
      if (gradeRecord) {
        await window.dataSdk.delete(gradeRecord);
      }
    }

    function updateJournal() {
      document.getElementById('total-students').textContent = allStudents.length;

      const tbody = document.getElementById('journal-tbody');
      tbody.innerHTML = '';

      if (allStudents.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">üì≠ –ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ —É—á–µ–Ω–∏–∫–∞ –∏ –≤—ã—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫—É.</td></tr>';
        document.getElementById('avg-grade').textContent = '0';
        document.getElementById('total-grades').textContent = '0';
        document.getElementById('percentage-graded').textContent = '0%';
        return;
      }

      let totalGrades = 0;
      let sumScores = 0;

      allStudents.forEach(student => {
        const gradeRecord = allGrades.find(g => g.student_name === student);
        totalGrades += gradeRecord ? 1 : 0;
        if (gradeRecord) sumScores += gradeRecord.score;

        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="font-semibold text-gray-800">${student}</td>
          <td class="text-gray-600">${gradeRecord ? gradeRecord.date : '‚Äî'}</td>
          <td class="text-center">
            <div class="grade-cell ${gradeRecord ? getGradeColor(gradeRecord.score) : 'empty-grade'}" onclick="openGradeModal('${student}')">
              ${gradeRecord ? gradeRecord.score : '‚óã'}
            </div>
          </td>
          <td class="text-gray-600 text-sm">${gradeRecord && gradeRecord.comment ? gradeRecord.comment : '‚Äî'}</td>
          <td class="text-center flex gap-2 justify-center">
            ${gradeRecord ? `<button onclick="openGradeModal('${student}')" class="text-purple-600 font-bold hover:underline">‚úèÔ∏è</button>` : `<button onclick="openGradeModal('${student}')" class="text-green-600 font-bold hover:underline">‚ûï</button>`}
            <button class="delete-btn" onclick="deleteStudent('${student}')">üóëÔ∏è</button>
          </td>
        `;
        tbody.appendChild(row);
      });

      document.getElementById('total-grades').textContent = totalGrades;
      const avgGrade = totalGrades > 0 ? (sumScores / totalGrades).toFixed(1) : '0';
      document.getElementById('avg-grade').textContent = avgGrade;

      const percentage = allStudents.length > 0 ? Math.round((totalGrades / allStudents.length) * 100) : 0;
      document.getElementById('percentage-graded').textContent = percentage + '%';
    }

    function getGradeColor(score) {
      if (score <= 2) return 'grade-1-2';
      if (score <= 4) return 'grade-3-4';
      if (score <= 6) return 'grade-5-6';
      if (score <= 8) return 'grade-7-8';
      return 'grade-9-10';
    }

    async function onConfigChange(cfg) {
      config = { ...defaultConfig, ...cfg };
      document.getElementById('journal-title').textContent = config.journal_title;
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: () => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (cfg) => new Map([
          ['journal_title', cfg.journal_title || defaultConfig.journal_title]
        ])
      });
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ca237de2554bcb7',t:'MTc3MDQ2MDI5My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>